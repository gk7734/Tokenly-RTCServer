# μ¬μ—°κ²° λ΅μ§ ν…μ¤νΈ κ°€μ΄λ“

## 1. κΈ°λ³Έ ν…μ¤νΈ ν™κ²½ μ¤€λΉ„

### μ„λ²„ μ‹¤ν–‰
```bash
cargo run
```

### μ—°κ²° μƒνƒ ν™•μΈ
```bash
curl -s http://localhost:3003/status | jq
```

## 2. WebSocket ν΄λΌμ΄μ–ΈνΈλ΅ κΈ°λ³Έ ν…μ¤νΈ

### Node.js ν΄λΌμ΄μ–ΈνΈ μ‹¤ν–‰
```bash
node test_client.js
```

### ν΄λΌμ΄μ–ΈνΈ μ΅°μ‘ ν‚¤
- `q`: ν΄λΌμ΄μ–ΈνΈ μΆ…λ£
- `r`: μλ™ μ¬μ—°κ²°
- `f`: λ„¤νΈμ›ν¬ μ‹¤ν¨ μ‹λ®¬λ μ΄μ… (κ°•μ  μ—°κ²° μΆ…λ£)
- `s`: μ„λ²„ μƒνƒ ν™•μΈ
- `m`: ν…μ¤νΈ λ©”μ‹μ§€ μ „μ†΅

## 3. λ„¤νΈμ›ν¬ μ¤‘λ‹¨ μ‹λ®¬λ μ΄μ… λ°©λ²•

### 3.1. ν΄λΌμ΄μ–ΈνΈμ—μ„ κ°•μ  μΆ…λ£ (κ°€μ¥ κ°„λ‹¨)
- ν…μ¤νΈ ν΄λΌμ΄μ–ΈνΈμ—μ„ `f` ν‚¤λ¥Ό λλ¬ `ws.terminate()` μ‹¤ν–‰
- μ„λ²„ μΈ΅μ—μ„ λ„¤νΈμ›ν¬ μ¤λ¥λ΅ κ°μ§€λ¨

### 3.2. ν”„λ΅μ„Έμ¤ μΌμ‹ μ •μ§€/μ¬κ° (macOS/Linux)
```bash
# μ„λ²„ ν”„λ΅μ„Έμ¤ μ°ΎκΈ°
ps aux | grep Tokenly

# ν”„λ΅μ„Έμ¤ μΌμ‹ μ •μ§€ (SIGSTOP)
kill -STOP <PID>

# 10μ΄ ν›„ ν”„λ΅μ„Έμ¤ μ¬κ° (SIGCONT)
sleep 10 && kill -CONT <PID>
```

### 3.3. λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤ μ°¨λ‹¨ (κ³ κΈ‰)
```bash
# νΉμ • ν¬νΈ μ°¨λ‹¨ (root κ¶ν• ν•„μ”)
sudo pfctl -f /dev/stdin <<< "block drop proto tcp from any to any port 3003"

# μ°¨λ‹¨ ν•΄μ 
sudo pfctl -f /etc/pf.conf
```

### 3.4. Docker λ„¤νΈμ›ν¬ μ‹λ®¬λ μ΄μ… (κ¶μ¥)
```bash
# Dockerλ΅ λ„¤νΈμ›ν¬ μ§€μ—°/μ†μ‹¤ μ‹λ®¬λ μ΄μ…
docker run -it --rm --cap-add=NET_ADMIN nicolaka/netshoot tc qdisc add dev eth0 root netem delay 100ms loss 10%
```

### 3.5. TCP μ—°κ²° κ°•μ  μΆ…λ£
```bash
# ν„μ¬ μ—°κ²°λ μ†μΌ“ ν™•μΈ
lsof -i :3003

# νΉμ • μ—°κ²° κ°•μ  μΆ…λ£ (tcpkill μ‚¬μ©)
sudo tcpkill -i lo0 port 3003
```

## 4. ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

### 4.1. μ •μƒ μ¬μ—°κ²° ν…μ¤νΈ
1. ν΄λΌμ΄μ–ΈνΈ μ—°κ²°
2. μ„λ²„ μƒνƒ ν™•μΈ (`connected`)
3. ν΄λΌμ΄μ–ΈνΈμ—μ„ `f` ν‚¤λ΅ λ„¤νΈμ›ν¬ μ‹¤ν¨ μ‹λ®¬λ μ΄μ…
4. ν΄λΌμ΄μ–ΈνΈ μλ™ μ¬μ—°κ²° ν™•μΈ
5. μ„λ²„ μƒνƒ λ³€ν™” κ΄€μ°°

### 4.2. μ§€μ λ°±μ¤ν”„ ν…μ¤νΈ
1. ν΄λΌμ΄μ–ΈνΈ μ—°κ²°
2. μ„λ²„ ν”„λ΅μ„Έμ¤ μΆ…λ£ (`Ctrl+C`)
3. ν΄λΌμ΄μ–ΈνΈμ μ¬μ—°κ²° μ‹λ„ κ°„κ²© ν™•μΈ (1μ΄, 2μ΄, 4μ΄, 8μ΄, 16μ΄)
4. 5ν μ‹λ„ ν›„ ν¬κΈ° ν™•μΈ

### 4.3. μ„λ²„ μ¬μ‹μ‘ ν…μ¤νΈ
1. ν΄λΌμ΄μ–ΈνΈ μ—°κ²°
2. μ„λ²„ μ¬μ‹μ‘
3. ν΄λΌμ΄μ–ΈνΈ μλ™ μ¬μ—°κ²° ν™•μΈ

### 4.4. ν•νΈλΉ„νΈ ν…μ¤νΈ
1. ν΄λΌμ΄μ–ΈνΈ μ—°κ²° (ν•νΈλΉ„νΈ ν™μ„±ν™”)
2. λ„¤νΈμ›ν¬ μ§€μ—° μ‹λ®¬λ μ΄μ…
3. Ping/Pong λ©”μ‹μ§€ ν™•μΈ
4. νƒ€μ„μ•„μ›ƒ λ°μƒ μ‹ μ¬μ—°κ²° ν™•μΈ

## 5. μμƒ λ΅κ·Έ μ¶λ ¥

### μ •μƒ μ—°κ²°
```
[2024-01-01T10:00:00.000Z] WebSocket μ—°κ²° μ‹λ„: ws://localhost:3003/rtc
[2024-01-01T10:00:00.001Z] β… WebSocket μ—°κ²° μ„±κ³µ
[2024-01-01T10:00:00.002Z] π“¤ μ „μ†΅: {"type":"create-peer","session_id":"test-session-1704096000000","room_id":"test-room-001"}
```

### λ„¤νΈμ›ν¬ μ‹¤ν¨ λ° μ¬μ—°κ²°
```
[2024-01-01T10:00:30.000Z] π’¥ λ„¤νΈμ›ν¬ μ‹¤ν¨ μ‹λ®¬λ μ΄μ… - μ—°κ²° κ°•μ  μΆ…λ£
[2024-01-01T10:00:30.001Z] β WebSocket μ—°κ²° μΆ…λ£ (μ½”λ“: 1006, μ΄μ : )
[2024-01-01T10:00:30.002Z] π”„ μ¬μ—°κ²° μ‹λ„ 1/5 - 1000ms ν›„ μ‹λ„
[2024-01-01T10:00:31.003Z] WebSocket μ—°κ²° μ‹λ„: ws://localhost:3003/rtc
[2024-01-01T10:00:31.004Z] β… WebSocket μ—°κ²° μ„±κ³µ
```

### μ„λ²„ μƒνƒ λ³€ν™”
```bash
# μ—°κ²° μ „
curl -s http://localhost:3003/status | jq
{
  "state": "disconnected",
  "active_sessions": 0,
  "reconnect_attempts": 0,
  "max_attempts": 5,
  "next_delay_seconds": 1,
  "last_attempt": null
}

# μ—°κ²° ν›„
{
  "state": "connected",
  "active_sessions": 1,
  "reconnect_attempts": 0,
  "max_attempts": 5,
  "next_delay_seconds": 1,
  "last_attempt": null
}
```

## 6. λ¬Έμ  ν•΄κ²°

### ν¬νΈ μ¶©λ
```bash
# ν¬νΈ μ‚¬μ© μ¤‘μΈ ν”„λ΅μ„Έμ¤ ν™•μΈ
lsof -i :3003

# ν”„λ΅μ„Έμ¤ μΆ…λ£
kill -9 <PID>
```

### Node.js WebSocket λ¨λ“ μ„¤μΉ
```bash
npm install ws
```

### κ¶ν• λ¬Έμ  (λ„¤νΈμ›ν¬ μ°¨λ‹¨ ν…μ¤νΈ)
```bash
# macOSμ—μ„ pfctl μ‚¬μ© μ‹ root κ¶ν• ν•„μ”
sudo pfctl -sa  # ν„μ¬ κ·μΉ™ ν™•μΈ
```

## 7. κ³ κΈ‰ ν…μ¤νΈ λ„κµ¬

### Wiresharkλ΅ ν¨ν‚· λ¶„μ„
- WebSocket ν•Έλ“μ…°μ΄ν¬ λ° λ°μ΄ν„° ν”„λ μ„ λ¶„μ„
- μ—°κ²° μΆ…λ£ ν¨ν„΄ κ΄€μ°°

### Apache Bench (ab)λ΅ λ¶€ν• ν…μ¤νΈ
```bash
# λ‹¤μμ WebSocket μ—°κ²°λ΅ λ¶€ν• ν…μ¤νΈ
# (μ¶”κ°€ μ¤ν¬λ¦½νΈ ν•„μ”)
```

μ΄ κ°€μ΄λ“λ¥Ό ν†µν•΄ λ‹¤μ–‘ν• λ„¤νΈμ›ν¬ μƒν™©μ—μ„ μ¬μ—°κ²° λ΅μ§μ„ μ²΄κ³„μ μΌλ΅ ν…μ¤νΈν•  μ μμµλ‹λ‹¤.